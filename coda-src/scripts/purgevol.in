#!/bin/sh
# BLURB gpl
#
#                            Coda File System
#                               Release 7
#
#           Copyright (c) 1987-2019 Carnegie Mellon University
#                   Additional copyrights listed below
#
# This  code  is  distributed "AS IS" without warranty of any kind under
# the terms of the GNU General Public Licence Version 2, as shown in the
# file  LICENSE.  The  technical and financial  contributors to Coda are
# listed in the file CREDITS.
#
#                         Additional copyrights
#                            none currently
#
#*/

prefix=@prefix@
exec_prefix=@exec_prefix@

PATH=$PATH:$prefix/sbin
export PATH

# load the server configuration file
vicedir=/vice
. "$(@sbindir@/codaconfedit server.conf)"

scm=$(cat "$vicedir/db/scm")
if [ "$(cat "$vicedir/hostname")" != "$scm" ]
then
        echo "This must be run from the scm ($scm)"
        exit 1
fi

# Check that the input parameters are correct
if [ $# = 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]
then
	echo "purgevol volumename"
	exit 1
fi

if [ "$1" = "--kill" ]
then
    dryrun=0
    shift
else
    dryrun=1
    echo "Only testing, use 'purgevol --kill $1' to really purge the volume"
fi

volname=$1
SRV=$scm

volutil -h "$SRV" getvolumelist "/tmp/vollist.$$" 2>/dev/null

# Don't purge volume replicas
egrep '^[WRB]'"${volname}"'\.[0-7] ' "/tmp/vollist.$$" >/dev/null
if [ $? -eq 0 ] ; then
    echo "$volname is a volume replica on $SRV"
    exit 1
fi

# Ask the SCM where the volume is located.
egrep '^[WRB]'"${volname}"' ' "/tmp/vollist.$$" >/dev/null
if [ $? -ne 0 ]; then
    echo "Couldn't get volume information for $volname"
    exit 1
fi

# Check that the volname isn't a replicated volume (ends with .N)
echo ${volname##*.} | egrep "[0-9]+$" > /dev/null
if [ $? -eq 0 ] ; then
    echo "$volname is a volume replica name on $SRV"
    exit 1
fi

# Get the Volume ID
volid=$(grep '^[WRB]'"${volname}"' ' "/tmp/vollist.$$" | cut -d' ' -f2 | cut -c2-)

# Purge volume
if [ $dryrun = 0 ] ; then
    echo "Purging $volname ($volid) from $SRV"
    volutil -h "$SRV" purge "$volid" "$volname" 2>/dev/null
else
    echo "Would have purged $volname ($volid) from $SRV"
fi

if [ $dryrun = 0 ] ; then
  # Delete the entry from the backup list.
  if [ -e "$vicedir/db/dumplist" ] ; then
      awk "\$1 !~ /^$volid\$/ { print }" "$vicedir/db/dumplist" > "$vicedir/db/dumplist.tmp"
      mv "$vicedir/db/dumplist.tmp" "$vicedir/db/dumplist"
  fi

  bldvldb.sh $SRV
else
  echo "Don't forget we were only testing"
  echo "use 'purgevol --kill $1' to really purge the volume"
fi

